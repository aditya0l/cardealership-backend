# üîç How Everything Works - Complete Explanation

## Your Questions Answered:

---

## 1Ô∏è‚É£ **How Does Backend Have Stocks?**

### ‚úÖ Currently Implemented:

**Database Table:** `Vehicle` (see schema.prisma lines 200-242)

**Stock Structure:**
```typescript
Vehicle {
  id: string
  variant: "Tata Nexon XZ+"
  color: "Blue"
  fuelType: "Petrol"
  transmission: "Automatic"
  
  // Stock locations (Boolean flags):
  zawlStock: true/false      // ZAWL warehouse
  rasStock: true/false       // RAS warehouse
  regionalStock: true/false  // Regional stock
  plantStock: true/false     // Plant stock
  
  // Pricing:
  exShowroomPrice: 1200000
  finalBillingPrice: 1150000
  onRoadPrice: 1450000
  
  // Dealer association:
  dealerId: "dealer_id_here"
  dealerType: "TATA" or "Universal"
}
```

**API Endpoints:**
```
‚úÖ GET /api/stock - View all vehicles
‚úÖ POST /api/stock - Create vehicle (Admin/GM/SM)
‚úÖ PUT /api/stock/:id - Update vehicle
‚úÖ DELETE /api/stock/:id - Delete vehicle
```

**How It Works:**
1. Admin uploads vehicles with stock status
2. Each vehicle has boolean flags for different warehouse locations
3. When converting enquiry‚Üíbooking, system checks if ANY stock location has `true`
4. If in stock ‚Üí booking created
5. If no stock ‚Üí error returned

---

## 2Ô∏è‚É£ **Dealerships & Models**

### ‚úÖ Dealership System:

**Database Table:** `Dealer` (schema.prisma lines 116-131)

```typescript
Dealer {
  id: string
  dealerCode: "TATA001" (unique)
  dealerName: "Tata Motors Delhi"
  location: "Delhi"
  zone: "NORTH"
  region: "Delhi NCR"
  dealerType: "TATA" or "Universal"
  isActive: true/false
  
  // Relations:
  bookings: Booking[]  // All bookings for this dealer
  vehicles: Vehicle[]  // Stock specific to this dealer
}
```

**Current Status:**
```
‚úÖ Dealers table exists
‚úÖ Vehicles linked to dealers
‚úÖ Bookings have dealerCode field
‚úÖ Multi-dealer support working
```

**What's Being Used:**
- Bookings have `dealerCode` (e.g., "TATA001")
- Vehicles can be dealer-specific (`dealerId` field)
- Dealers have their own vehicle inventory

---

## 3Ô∏è‚É£ **Employee ID Creation & Booking Assignment**

### ‚úÖ How Employee IDs Work Now:

**Employee ID = Firebase UID** (auto-generated by Firebase)

**User Creation Process:**

#### Method 1: Admin Creates User (Recommended)
```
POST /api/auth/users/create-with-credentials

Body:
{
  "name": "New Advisor",
  "email": "advisor@dealership.com",
  "password": "SecurePass123!",
  "roleName": "CUSTOMER_ADVISOR"
}

Backend does:
1. ‚úÖ Creates Firebase user ‚Üí Gets unique UID
2. ‚úÖ Creates user in database with that UID
3. ‚úÖ Sets role (CUSTOMER_ADVISOR)
4. ‚úÖ User can now login
5. ‚úÖ UID is used as employeeId everywhere
```

**Example:**
```
New user created:
  firebaseUid: "kryTfSsgR7MRqZW5qYMGE9liI9s1" ‚Üê This is the employee ID
  name: "John Advisor"
  email: "john@dealership.com"
  role: CUSTOMER_ADVISOR
```

---

### ‚úÖ How Booking Assignment Works:

#### Option 1: Auto-Assignment (Advisors)
```typescript
// When advisor converts enquiry to booking:
PUT /api/enquiries/:id
Body: { category: "BOOKED" }

Result:
- Booking created automatically
- advisorId = current logged-in advisor's UID
- Advisor owns the booking
```

#### Option 2: Manual Assignment (Admin/Managers)
```typescript
// Admin assigns booking to specific advisor:
PATCH /api/bookings/:bookingId/assign
Body: {
  "advisorId": "kryTfSsgR7MRqZW5qYMGE9liI9s1",  // Employee's Firebase UID
  "reason": "Assigning to John for follow-up"
}

Backend:
1. ‚úÖ Validates advisor exists
2. ‚úÖ Validates advisor has CUSTOMER_ADVISOR role
3. ‚úÖ Updates booking.advisorId
4. ‚úÖ Changes status to IN_PROGRESS
5. ‚úÖ Creates audit log
```

#### Option 3: Bulk Import with Assignment
```typescript
// Excel upload with advisor_id column:
| customer_name | variant | advisor_id                    |
|---------------|---------|-------------------------------|
| John Doe      | Nexon   | kryTfSsgR7MRqZW5qYMGE9liI9s1 |

- Bulk import validates each advisor_id
- Assigns bookings automatically during import
```

---

## 4Ô∏è‚É£ **Complete System Flow**

### Flow 1: Advisor Creates Enquiry ‚Üí Booking

```
1. Advisor logs in (Firebase auth)
   ‚Üì
2. Creates enquiry via mobile app
   POST /api/enquiries
   ‚Üì
3. Enquiry saved with:
   - createdByUserId = advisor's UID
   - category = HOT
   - status = OPEN
   ‚Üì
4. When ready to book, advisor updates:
   PUT /api/enquiries/:id { category: "BOOKED" }
   ‚Üì
5. Backend checks stock:
   - Finds vehicle with matching variant
   - Checks stock locations (zawl/ras/regional/plant)
   ‚Üì
6. If IN STOCK:
   - Creates booking
   - Sets advisorId = advisor's UID automatically
   - Sets stockAvailability = VEHICLE_AVAILABLE
   - Closes enquiry
   ‚Üì
7. Advisor can now update booking fields:
   PUT /api/bookings/:id/update-status
   - Add finance details
   - Set delivery date
   - Add remarks
```

### Flow 2: Admin Bulk Import ‚Üí Assignment

```
1. Admin uploads Excel with bookings
   POST /api/bookings/import/upload
   ‚Üì
2. Each row has advisor_id (optional)
   ‚Üì
3. Backend validates:
   - Customer details
   - Vehicle variant
   - Advisor exists (if provided)
   ‚Üì
4. Creates bookings:
   - With advisorId if provided
   - Without advisorId if not (unassigned)
   ‚Üì
5. Admin can later assign unassigned bookings:
   PATCH /api/bookings/:id/assign
   Body: { advisorId: "firebase_uid" }
```

### Flow 3: Stock Management

```
1. Admin adds vehicle to inventory:
   POST /api/stock
   Body: {
     variant: "Tata Nexon XZ+",
     color: "Blue",
     fuelType: "Petrol",
     zawlStock: true,  // Available in ZAWL
     rasStock: false,  // Not in RAS
     exShowroomPrice: 1200000,
     dealerId: "dealer_id_here"
   }
   ‚Üì
2. Vehicle saved in database
   ‚Üì
3. When enquiry converts to booking:
   - System queries: Vehicle where variant matches
   - Checks: zawlStock OR rasStock OR regionalStock OR plantStock
   - If ANY = true ‚Üí In stock
   - If ALL = false ‚Üí Out of stock
   ‚Üì
4. Booking gets stockAvailability field set
```

---

## üìä **Current Implementation Status**

| Feature | Status | Notes |
|---------|--------|-------|
| **Stock Management** | ‚úÖ Working | Vehicles table with stock flags |
| **Dealerships** | ‚úÖ Working | Dealers table, multi-dealer support |
| **Employee Creation** | ‚úÖ Working | Admin creates with Firebase UID |
| **Booking Assignment** | ‚úÖ Working | 3 methods: auto, manual, bulk |
| **Stock Validation** | ‚úÖ Working | Checks before booking creation |
| **Manager Hierarchy** | ‚úÖ NEW! | Just added managerId field |

---

## üîß **What's Missing (Can Implement)**

### Not Yet Implemented:

1. ‚ùå **Custom Employee ID Format**
   - Currently: Uses Firebase UID (random)
   - Wanted: "EMP001", "EMP002", etc.?
   
2. ‚ùå **Dealer-Specific Stock**
   - Currently: All stock visible to all dealers
   - Wanted: Each dealer sees only their inventory?

3. ‚ùå **Stock Quantity Tracking**
   - Currently: Boolean (in stock yes/no)
   - Wanted: Actual counts (10 units, 5 units)?

4. ‚ùå **Model Master Data**
   - Currently: Variant names as strings
   - Wanted: Model table with variants, features?

---

## üí° **What I Can Implement For You**

**If you want:**

### 1. Custom Employee IDs
```
Instead of: kryTfSsgR7MRqZW5qYMGE9liI9s1
Use: EMP001, ADV001, TL001, etc.
```

### 2. Stock Quantity System
```
Instead of: zawlStock: true/false
Use: zawlStockCount: 10 units
```

### 3. Dealer-Specific Stock
```
Dealer A sees only their 50 vehicles
Dealer B sees only their 30 vehicles
```

### 4. Model Master Table
```
Model: "Tata Nexon"
  ‚îú‚îÄ Variant: "XZ+"
  ‚îú‚îÄ Variant: "XZ+ Lux"
  ‚îî‚îÄ Variant: "XM"
With features, specs, pricing tiers
```

---

## üéØ **Which Do You Want Me To Implement?**

Tell me and I'll implement it properly (no bypasses!):

**Option A:** Custom employee ID format (EMP001, etc.)  
**Option B:** Stock quantity tracking (actual counts)  
**Option C:** Dealer-specific inventory  
**Option D:** Model master data system  
**Option E:** All of the above  
**Option F:** Something else  

---

**I'm ready to implement whatever you need!** üöÄ

